# ---------------------------------------------------------
# Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…Ù†Ø·Ù‚ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù‡Ø§Ø¨ÛŒ (Ø³Ø§Ù…Ø§Ù†Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§Ù†Ú©ÛŒ)
# ---------------------------------------------------------
database:
  # ğŸŸ¢ [Gateway/Local]: Ù†Ø§Ù… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ÛŒ Ú©Ù‡ Ø¯Ø±ÙˆÙ† Ú©Ø§Ù†ØªÛŒÙ†Ø± Ù¾Ø³ØªÚ¯Ø±Ø³ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  name: brc_db
  
  # ğŸŸ¢ [Gateway/Local]: Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ø§Ù„Ú© Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ù¾Ø³ØªÚ¯Ø±Ø³ (Ù…Ø·Ø§Ø¨Ù‚ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§)
  owner: ${POSTGRES_USER}
  
  # ğŸŸ¢ [Gateway/Local]: ØªØ§ÛŒÙ…â€ŒØ²ÙˆÙ† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ùˆ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø±ÛŒâ€ŒØ²Ù…Ø§Ù†ÛŒ
  timezone: Asia/Tehran

# ---------------------------------------------------------
# ØªØ¹Ø±ÛŒÙ Ø§ØªØµØ§Ù„Ø§Øª FDW (Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ù‡ Ù…Ù†Ø§Ø¨Ø¹ Ø®Ø§Ø±Ø¬ÛŒ - Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§Ù†Ú©ÛŒ)
# ---------------------------------------------------------
fdws:
  - name: mssql_brc_link
    # ğŸŸ¢ [Gateway/Local]: Ù†Ø§Ù… Ø§ØªØµØ§Ù„ Ù…Ø­Ù„ÛŒ Ø¯Ø± Ù¾Ø³ØªÚ¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§Ù†Ú© Ù…Ø±Ú©Ø²ÛŒ
    type: tds                      # Ù†ÙˆØ¹ Ø¯Ø±Ø§ÛŒÙˆØ± (tds_fdw Ø¨Ø±Ø§ÛŒ SQL Server)
    
    # -------------------------------------------------
    # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…Ø¨Ø¯Ø§ (Remote SQL Server Ø¨Ø§Ù†Ú©)
    # -------------------------------------------------
    host: ${BRC_DB_HOST}           # ğŸŸ¡ [Source/Remote]: Ø¢ÛŒâ€ŒÙ¾ÛŒ Ø³Ø±ÙˆØ± SQL Server Ø¨Ø§Ù†Ú© (Ø§Ø² .env)
    port: ${BRC_DB_PORT}           # ğŸŸ¡ [Source/Remote]: Ù¾ÙˆØ±Øª Ø³Ø±ÙˆØ± SQL Server (Ø§Ø² .env)
    database: ${BRC_DB_Name}       # ğŸŸ¡ [Source/Remote]: Ù†Ø§Ù… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÙˆØ§Ù‚Ø¹ÛŒ (Ø§Ø² .env)
    user: ${BRC_DB_USER}           # ğŸŸ¡ [Source/Remote]: Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ (Ø§Ø² .env)
    password: ${BRC_DB_PASSWORD}   # ğŸŸ¡ [Source/Remote]: Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø§Ø² .env)
    
    # âœ¨ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆØªÚ©Ù„ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ DB-Library error 20018
    # Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ø´Ù…Ø§ SQL Server 2019/2022 Ø§Ø³ØªØŒ '7.4' Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³Øª.
    # Ø§Ú¯Ø± SQL Server 2008 Ø§Ø³ØªØŒ Ø§Ø² '7.1' ÛŒØ§ '7.2' Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
    tds_version: "7.4" 

    # Ù†Ø§Ù… Ø¨Ø®Ø´ÛŒ Ú©Ù‡ Ø¯Ø± freetds.conf ØªØ¹Ø±ÛŒÙ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯
    # Ø§Ú¯Ø± Ø§ÛŒÙ† Ø±Ø§ Ù†Ø¯Ù‡ÛŒØ¯ØŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø² name: mssql_brc_link Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    config_section: BRC
# ---------------------------------------------------------
# ØªØ¹Ø±ÛŒÙ Ø§Ø³Ú©ÛŒÙ…Ø§Ù‡Ø§ (Ø¯Ø± Gateway Ù¾Ø³ØªÚ¯Ø±Ø³)
# ---------------------------------------------------------
schemas:
  # ğŸŸ¢ [Gateway/Local]: Ø§Ø³Ú©ÛŒÙ…Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù… Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ù†Ú©ÛŒ
  - name: external_raw
  
  # ğŸŸ¢ [Gateway/Local]: Ø§Ø³Ú©ÛŒÙ…Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„
  - name: staging
  
  # ğŸŸ¢ [Gateway/Local]: Ø§Ø³Ú©ÛŒÙ…Ø§ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ Ùˆ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ (Ø¨Ø±Ø§ÛŒ Ø§Ø¯ØºØ§Ù… Ø¨Ø§ MLflow/Airflow)
  - name: analytics

# ---------------------------------------------------------
# ØªØ¹Ø±ÛŒÙ Ø¬Ø¯Ø§ÙˆÙ„ Ø®Ø§Ø±Ø¬ÛŒ (Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ FDW)
# ---------------------------------------------------------
# ---------------------------------------------------------
# ØªØ¹Ø±ÛŒÙ Ø¬Ø¯Ø§ÙˆÙ„ Ø®Ø§Ø±Ø¬ÛŒ (Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ FDW)
# ---------------------------------------------------------
tables:
  # --- Ø¬Ø¯ÙˆÙ„ Ø®Ø§Ø±Ø¬ÛŒ: Ù‡Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù‡Ø§Ø¨ÛŒ ---
  - name: external_raw.kahabi_headers
    type: foreign
    server: mssql_brc_link
    remote_schema: dbo
    remote_table: KahabiHeaders
    columns:
      - {name: id, type: integer}
      - {name: filename, type: text}
      - {name: abbreviatedname, type: text}
      - {name: abbreviatedcompany, type: text}
      - {name: senddate, type: text}
      - {name: readdatetime, type: timestamp}
      - {name: headertitle, type: text}
      - {name: servicecode, type: smallint}
      - {name: subjectcode, type: smallint}
      - {name: bankcode, type: integer}
      - {name: totalamount, type: bigint}
      - {name: rowcounts, type: integer}
      - {name: senddateheader, type: text}

  # --- Ø¬Ø¯ÙˆÙ„ Ø®Ø§Ø±Ø¬ÛŒ: Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ø®Ø·Ø§Ù‡Ø§ ---
  - name: external_raw.kahabi_logs
    type: foreign
    server: mssql_brc_link
    remote_schema: dbo
    remote_table: KahabiLogs
    columns:
      - {name: id, type: integer}
      - {name: file_name, type: text}
      - {name: file_date, type: timestamp}
      - {name: read_date_time, type: timestamp}
      - {name: status_insert, type: boolean}
      - {name: error_code, type: smallint}
      - {name: error_comment, type: text}
      - {name: central_bankcode, type: integer}
      - {name: service_code, type: smallint}

  # --- Ø¬Ø¯ÙˆÙ„ Ø®Ø§Ø±Ø¬ÛŒ: Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒØ´Ø¯Ù‡ Ú©Ø§Ù‡Ø§Ø¨ÛŒ ---
  - name: external_raw.kahabi_rows
    type: foreign
    server: mssql_brc_link
    remote_schema: BrcDbNew.dbo
    remote_table: KahabiRows
    columns:
      - {name: id_header, type: integer}
      - {name: row_num, type: integer}
      - {name: strings, type: text}
      - {name: operating_branch_code, type: text}
      - {name: payment_method, type: text}
      - {name: pay_date, type: date}
      - {name: billing_id, type: text}
      - {name: payment_code, type: text}
      - {name: tracking_code, type: text}
      - {name: amount, type: bigint}
      - {name: record_id, type: uuid}

# ---------------------------------------------------------
# ØªØ¹Ø±ÛŒÙ ÙˆÛŒÙˆÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ (Ù„Ø§ÛŒÙ‡ Ù‡ÙˆØ´ ØªØ¬Ø§Ø±ÛŒ Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ø§Ø´ÛŒÙ†)
# ---------------------------------------------------------
views:
  # --- ÙˆÛŒÙˆÛŒ ØªØ¬Ù…ÛŒØ¹ Ø±ÙˆØ²Ø§Ù†Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ (Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø±ÛŒâ€ŒØ²Ù…Ø§Ù†ÛŒ) ---
  - name: analytics.vw_daily_payments
    # ğŸŸ¢ [Gateway/Local]: ÙˆÛŒÙˆÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ (Prophet/XGBoost)
    sql: |
      SELECT 
        khr.pay_date AS payment_date,
        kh.bankcode,
        kh.servicecode,
        COUNT(*) AS transaction_count,
        SUM(khr.amount) AS total_amount_rial
      FROM external_raw.kahabi_rows khr
      JOIN external_raw.kahabi_headers kh 
        ON khr.id_header = kh.id
      WHERE khr.amount > 0 
        AND khr.pay_date IS NOT NULL
      GROUP BY 1, 2, 3
      ORDER BY payment_date DESC

  # --- ÙˆÛŒÙˆÛŒ Ù†Ø§Ù‡Ù†Ø¬Ø§Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª (Ø¨Ø±Ø§ÛŒ Ø§Ø¯ØºØ§Ù… Ø¨Ø§ Isolation Forest) ---
  - name: analytics.vw_anomaly_features
    # ğŸŸ¢ [Gateway/Local]: ÙˆÛŒÙˆÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ù†Ø§Ù‡Ù†Ø¬Ø§Ø±ÛŒ
    sql: |
      SELECT 
        khr.record_id,
        khr.pay_date,
        khr.amount,
        kh.bankcode,
        EXTRACT(DOW FROM khr.pay_date) AS day_of_week,
        EXTRACT(DOY FROM khr.pay_date) AS day_of_year
      FROM external_raw.kahabi_rows khr
      JOIN external_raw.kahabi_headers kh 
        ON khr.id_header = kh.id
      WHERE khr.amount > 0 
        AND khr.pay_date >= CURRENT_DATE - INTERVAL '30 days'

  - name:  external_raw.vw_kahabi_headers
    # ğŸŸ¢ [Gateway/Local]: ÙˆÛŒÙˆÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ù†Ø§Ù‡Ù†Ø¬Ø§Ø±ÛŒ
    sql: |
      SELECT 
          id, 
          filename, 
          abbreviatedname, 
          abbreviatedcompany,           
          COALESCE(to_date(senddate, 'Mon DD YYYY'),senddate::date ) AS senddate, 
          readdatetime, 
          headertitle, 
          servicecode, 
          subjectcode, 
          bankcode, 
          totalamount, 
          rowcounts, 
          COALESCE(to_date(senddateheader, 'Mon DD YYYY'),senddateheader::date ) AS senddateheader
      FROM external_raw.kahabi_headers;

# ---------------------------------------------------------
# ØªØ¹Ø±ÛŒÙ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ (Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù†ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ)
# ---------------------------------------------------------
users:
  # ğŸŸ¢ [Gateway/Local]: ØªØ­Ù„ÛŒÙ„â€ŒÚ¯Ø± Ø¯Ø§Ø¯Ù‡ (Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±Ø­Ø³Ø§Ø³)
  - name: ${BI_USER_NAME}
    password: ${BI_USER_PASS}
    
    # ğŸŸ¢ [Gateway/Local]: Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ (Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ Ø¨Ø§Ù†Ú©)
    access_time:
      start: "08:00"
      end: "10:30"
    
    permissions:
      - view:
          # ğŸŸ¢ [Gateway/Local]: Ø¯Ø³ØªØ±Ø³ÛŒ ÙÙ‚Ø· Ø¨Ù‡ ÙˆÛŒÙˆÛŒ ØªØ¬Ù…ÛŒØ¹ Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ø®Ø§Ù…)
          name: analytics.vw_daily_payments
          columns: [payment_date, transaction_count, total_amount_rial]
      
      - table:
          # ğŸŸ¢ [Gateway/Local]: Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø®Ø·Ø§ (Ø¨Ø¯ÙˆÙ† Ø¬Ø²Ø¦ÛŒØ§Øª Ø­Ø³Ø§Ø³)
          name: external_raw.kahabi_logs
          columns: [id, read_date_time, error_code]

  # ğŸŸ¢ [Gateway/Local]: Ù…Ù‡Ù†Ø¯Ø³ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ø§Ø´ÛŒÙ† (Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯Ù„)
  - name: ${ML_ENGINEER_NAME}
    password: ${ML_ENGINEER_PASS}
    # Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ (Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¯Ø± ØºÛŒØ± Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ)
    permissions:
      - view:
          # ğŸŸ¢ [Gateway/Local]: Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ù‡ ÙˆÛŒÙˆÛŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù‡Ù†Ø¬Ø§Ø±ÛŒ
          name: analytics.vw_anomaly_features
      
      - view:
          # ğŸŸ¢ [Gateway/Local]: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ¬Ù…ÛŒØ¹â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ
          name: analytics.vw_daily_payments

      - view:
          # ğŸŸ¢ [Gateway/Local]: Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ¬Ù…ÛŒØ¹â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ
          name: external_raw.vw_kahabi_headers

      - table:
          # ğŸŸ¢ [Gateway/Local]: Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø®Ø·Ø§ (Ø¨Ø¯ÙˆÙ† Ø¬Ø²Ø¦ÛŒØ§Øª Ø­Ø³Ø§Ø³)
          name: external_raw.kahabi_headers

  # ğŸŸ¢ [Gateway/Local]: Ø§Ù¾Ø±Ø§ØªÙˆØ± Ø³ÛŒØ³ØªÙ… (Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ)
  - name: ${SYSOP_NAME}
    password: ${SYSOP_PASS}
    permissions:      
      - table:
          # ğŸŸ¢ [Gateway/Local]: Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´
          name: external_raw.kahabi_logs

  - name: ${PENDAR_ETL_USER}
    password: ${PENDAR_ETL_PASS}

    permissions:
      - table:
          name: external_raw.kahabi_headers
